package com.gael.chunkdata;

import net.minecraft.client.MinecraftClient;
import net.minecraft.text.Text;
import net.minecraft.util.Formatting;
import net.minecraft.util.math.ChunkPos;

public final class ChunkDataLocalCommandRouter {
    private ChunkDataLocalCommandRouter() {}

    public static void handle(String commandNoSlash) {
        String[] parts = commandNoSlash.trim().split("\\s+");
        if (parts.length == 0) return;

        if (parts.length == 1) {
            help();
            return;
        }

        String sub = parts[1].toLowerCase();

        switch (sub) {
            case "here" -> here();
            case "top" -> {
                int count = 10;
                if (parts.length >= 3) {
                    try { count = Math.max(1, Math.min(50, Integer.parseInt(parts[2]))); }
                    catch (NumberFormatException ignored) {}
                }
                top(count);
            }
            case "clear" -> {
                ChunkDataStore.clear();
                msg("Cleared stored results.");
            }
            case "heatmap" -> heatmap(parts);
            default -> help();
        }
    }

    private static void heatmap(String[] parts) {
        if (parts.length == 2) {
            msg("Heatmap is " + (ChunkDataConfig.HEATMAP_ENABLED ? "ON" : "OFF") +
                " (toggle H). Green-only is " + (ChunkDataConfig.ABNORMAL_ONLY_MODE ? "ON" : "OFF") + ".");
            return;
        }

        String a = parts[2].toLowerCase();

        if (a.equals("on") || a.equals("off") || a.equals("toggle")) {
            if (a.equals("toggle")) ChunkDataConfig.HEATMAP_ENABLED = !ChunkDataConfig.HEATMAP_ENABLED;
            else ChunkDataConfig.HEATMAP_ENABLED = a.equals("on");
            msg("Heatmap " + (ChunkDataConfig.HEATMAP_ENABLED ? "enabled" : "disabled") + " (toggle H).");
            return;
        }

        if (a.equals("abnormalonly")) {
            if (parts.length < 4) {
                msg("Usage: /chunkdata heatmap abnormalonly on|off|toggle");
                return;
            }
            String v = parts[3].toLowerCase();
            if (v.equals("toggle")) ChunkDataConfig.ABNORMAL_ONLY_MODE = !ChunkDataConfig.ABNORMAL_ONLY_MODE;
            else if (v.equals("on")) ChunkDataConfig.ABNORMAL_ONLY_MODE = true;
            else if (v.equals("off")) ChunkDataConfig.ABNORMAL_ONLY_MODE = false;

            msg("Green-only mode " + (ChunkDataConfig.ABNORMAL_ONLY_MODE ? "ON" : "OFF") + ".");
            return;
        }

        help();
    }

    private static void help() {
        msg("Usage: /chunkdata <here|top|clear|heatmap> ...");
    }

    private static void here() {
        if (MinecraftClient.getInstance().player == null) { msg("No player."); return; }
        ChunkPos cp = new ChunkPos(MinecraftClient.getInstance().player.getBlockPos());
        msg("Current chunk: " + cp.x + ", " + cp.z);
    }

    private static void top(int count) {
        msg("Top " + count + " (not implemented).");
    }

    private static void msg(String s) {
        if (MinecraftClient.getInstance().player != null)
            MinecraftClient.getInstance().player.sendMessage(Text.literal(s).formatted(Formatting.YELLOW), false);
        else
            System.out.println(s);
    }
}
